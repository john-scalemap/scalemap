# Story 2.4: Assessment Data Validation and Gap Detection

## Status
Done

## Story
**As a** ScaleMap user,
**I want** the system to identify any critical information gaps in my assessment,
**so that** I can provide additional details to ensure accurate analysis and recommendations.

## Acceptance Criteria
1. Automated assessment completeness scoring across all 12 domains with gap identification
2. Intelligent follow-up question generation for domains with insufficient data or conflicting responses
3. Critical vs nice-to-have data gap classification with user-friendly prioritization
4. Real-time gap detection during assessment completion with inline prompting for additional details
5. Post-submission gap analysis with email notification and portal-based gap-filling interface
6. Industry-specific gap detection rules for regulated industries and complex operational environments
7. Assessment timeline pause capability when critical gaps are identified, with clear next steps communication

## Tasks / Subtasks

- [x] **Task 1: Automated Assessment Completeness Scoring System** (AC: 1)
  - [x] Create gap detection service with domain-specific scoring algorithms
  - [x] Implement completeness percentage calculation for each of the 12 operational domains
  - [x] Build gap identification logic that analyzes response depth and quality
  - [x] Create data gap classification system (critical, important, nice-to-have)
  - [x] Add unit tests for scoring algorithms and gap detection logic

- [x] **Task 2: Intelligent Follow-up Question Generation** (AC: 2)
  - [x] Integrate OpenAI service for context-aware follow-up question generation
  - [x] Build question generation prompts specific to each operational domain
  - [x] Implement conflict detection logic for contradictory responses across domains
  - [x] Create question categorization and prioritization system
  - [x] Add comprehensive testing for question generation scenarios

- [x] **Task 3: Real-time Gap Detection During Assessment** (AC: 4)
  - [x] Implement real-time validation during questionnaire completion
  - [x] Create inline prompting system for additional details
  - [x] Build progressive disclosure of follow-up questions based on responses
  - [x] Integrate with existing assessment form validation
  - [x] Add end-to-end testing for real-time gap detection flow

- [x] **Task 4: Post-submission Gap Analysis and Communication** (AC: 5)
  - [x] Create post-submission gap analysis Lambda function
  - [x] Build email notification system using SES for gap identification
  - [x] Implement portal-based gap-filling interface in the web app
  - [x] Create assessment update API endpoints for gap resolution
  - [x] Add integration tests for complete gap-filling workflow

- [x] **Task 5: Industry-specific Gap Detection Rules** (AC: 6)
  - [x] Research and implement regulated industry requirements (financial, healthcare, etc.)
  - [x] Create industry-specific validation rules and gap detection logic
  - [x] Build complex operational environment detection (multi-location, international)
  - [x] Implement conditional gap detection based on company profile
  - [x] Add comprehensive test coverage for industry-specific scenarios

- [x] **Task 6: Timeline Pause Capability and Communication** (AC: 7)
  - [x] Integrate with existing timeline management system from Story 2.3
  - [x] Create gap-triggered timeline pause logic with business rule validation
  - [x] Implement clear next steps communication system
  - [x] Build founder notification system for critical gaps requiring review
  - [x] Add unit and integration tests for timeline pause scenarios

- [x] **Task 7: API Endpoints and Database Schema Updates** (AC: 1,2,3,4,5,6,7)
  - [x] Create new assessment validation API endpoints
  - [x] Update DynamoDB schema for gap tracking and resolution
  - [x] Implement gap history and resolution audit trail
  - [x] Create assessment gap status tracking
  - [x] Add comprehensive API testing

## Dev Notes

### Previous Story Insights
From Story 2.3 (Intelligent Domain Triage), key learnings include:
- Timeline management system already established with pause/resume capabilities
- OpenAI integration patterns for AI-powered analysis are well-defined
- Industry-specific rules engine architecture is available for reuse
- DynamoDB access patterns for assessment data are established

### Data Models
Based on `docs/architecture/database-schema.md`, extend existing assessment schema:

**Assessment Gap Tracking Structure:**
```typescript
// New properties to add to Assessment.Data
gapAnalysis: {
  overallCompletenessScore: number; // 0-100%
  domainCompleteness: Record<OperationalDomain, {
    score: number;
    identifiedGaps: Array<{
      gapId: string;
      category: 'critical' | 'important' | 'nice-to-have';
      description: string;
      suggestedQuestions: string[];
      resolved: boolean;
      resolvedAt?: string;
    }>;
  }>;
  industrySpecificGaps: Array<{
    regulation: string;
    requirements: string[];
    complianceLevel: 'full' | 'partial' | 'missing';
  }>;
  lastAnalyzedAt: string;
  analysisVersion: string;
}
```

**Gap Resolution Tracking Entity:**
```typescript
PK: ASSESSMENT#{assessmentId}
SK: GAP#{gapId}
GSI2PK: GAP#{status}
GSI2SK: CREATED#{createdAt}

Data: {
  gapId: string;
  assessmentId: string;
  domain: OperationalDomain;
  category: 'critical' | 'important' | 'nice-to-have';
  description: string;
  detectedAt: string;
  suggestedQuestions: string[];
  clientResponse?: string;
  resolvedAt?: string;
  resolutionMethod: 'client-input' | 'auto-resolved' | 'founder-override';
  impactOnTimeline: boolean;
}
```

[Source: architecture/database-schema.md#Assessment, #clarification-requests]

### API Specifications
Based on `docs/architecture/api-specification.md`, new endpoints to implement:

**POST /assessments/{assessmentId}/gaps/analyze** - Trigger gap analysis
**GET /assessments/{assessmentId}/gaps** - Retrieve identified gaps
**POST /assessments/{assessmentId}/gaps/{gapId}/resolve** - Submit gap resolution
**PUT /assessments/{assessmentId}/gaps/bulk-resolve** - Bulk gap resolution

Follow existing authentication patterns using CognitoAuth and standard error response format.
[Source: architecture/api-specification.md#authentication, #error-handling]

### Component Specifications
Based on `docs/architecture/unified-project-structure.md`:

**Backend Components:**
- `apps/api/src/functions/assessment/analyze-gaps.ts` - Gap analysis Lambda
- `apps/api/src/functions/assessment/resolve-gap.ts` - Gap resolution handler
- `apps/api/src/services/gap-analysis-service.ts` - Core gap detection logic
- `packages/shared/src/types/gap-analysis.ts` - Gap-related TypeScript types

**Frontend Components:**
- `apps/web/src/components/assessment/GapDetectionPanel.tsx` - Real-time gap display
- `apps/web/src/components/assessment/GapResolutionModal.tsx` - Gap resolution interface
- `apps/web/src/hooks/useGapAnalysis.ts` - Gap analysis state management

[Source: architecture/unified-project-structure.md#function-organization]

### File Locations
**New Lambda Functions:**
- `apps/api/src/functions/assessment/analyze-gaps.ts`
- `apps/api/src/functions/assessment/resolve-gap.ts`
- `apps/api/src/functions/assessment/bulk-resolve-gaps.ts`

**Service Updates:**
- `apps/api/src/services/gap-analysis-service.ts` (new)
- `apps/api/src/services/assessment-service.ts` (extend existing)
- `apps/api/src/services/timeline-manager.ts` (integration with existing)

**Shared Types:**
- `packages/shared/src/types/gap-analysis.ts` (new)
- `packages/shared/src/types/assessment.ts` (extend existing)

**Frontend Components:**
- `apps/web/src/components/assessment/gap-detection/` (new directory)
- `apps/web/src/hooks/useGapAnalysis.ts` (new)
- `apps/web/src/stores/gap-analysis-store.ts` (new Zustand store)

[Source: architecture/unified-project-structure.md#backend-functions, #frontend-structure]

### Testing Requirements
Based on `docs/architecture/testing-strategy.md`:

**Unit Testing (Jest):**
- Minimum 80% coverage for gap detection algorithms
- Test gap scoring calculations with various domain response scenarios
- Mock OpenAI service for question generation testing
- Test industry-specific gap detection rules

**Integration Testing:**
- Live DynamoDB operations for gap tracking
- OpenAI API integration for question generation
- SES email delivery for gap notifications
- Timeline integration with pause/resume functionality

**Test File Locations:**
- `apps/api/src/functions/assessment/__tests__/analyze-gaps.test.ts`
- `apps/api/src/services/__tests__/gap-analysis-service.test.ts`
- `apps/web/src/components/assessment/__tests__/GapDetectionPanel.test.tsx`

**Test Data Requirements:**
- Assessment samples with varying completeness levels
- Industry-specific company profiles for regulated vs non-regulated testing
- Gap resolution scenarios for end-to-end testing

[Source: architecture/testing-strategy.md#unit-testing, #integration-testing, #test-data-management]

### Technical Constraints
**OpenAI Integration:**
- Follow existing cost optimization patterns from Story 2.3
- Use GPT-4o-mini for gap analysis (cost-effective)
- Implement circuit breaker patterns for API failures
- Target cost: <£0.10 per gap analysis

**Timeline Integration:**
- Must respect clarificationPolicy business rules from existing assessment schema
- Maximum 3 clarification requests per assessment
- Maximum 24 hours total timeline extension
- Integration with existing pause/resume logic

**Performance Requirements:**
- Real-time gap detection: <500ms response time
- Post-submission analysis: Complete within 2 minutes
- Email notifications: Deliver within 5 minutes of gap detection

[Source: architecture/tech-stack.md#ai-cost-management, architecture/database-schema.md#timeline-management]

### Security Considerations
**Data Protection:**
- Gap analysis data contains sensitive business information
- Follow existing encryption patterns for DynamoDB storage
- Implement proper access controls for gap resolution endpoints
- Audit trail for all gap-related activities

**Input Validation:**
- Validate all gap resolution inputs
- Sanitize client-provided additional context
- Rate limiting on gap analysis requests

[Source: architecture/coding-standards.md#security-standards]

## Testing

### Testing Standards
Based on `docs/architecture/testing-strategy.md`:

**Unit Test Requirements:**
- **Location**: `apps/api/src/functions/assessment/__tests__/`
- **Framework**: Jest with React Testing Library for frontend components
- **Coverage**: Minimum 80% for gap detection algorithms and business logic
- **Patterns**: Use factory pattern for test data generation, follow AAA (Arrange-Act-Assert) structure

**Integration Test Requirements:**
- **Environment**: Use production AWS services with test data cleanup
- **Focus Areas**: DynamoDB gap tracking operations, OpenAI question generation, SES gap notifications
- **Error Scenarios**: Test OpenAI API failures, timeline constraint violations, invalid gap resolution attempts

**Test Data Strategy:**
- Generate realistic assessment data with varying completeness levels
- Include industry-specific scenarios (regulated vs non-regulated)
- Use unique identifiers for parallel test execution
- Implement automated cleanup via DynamoDB TTL

**Performance Testing:**
- Real-time gap detection: <500ms response time target
- Gap analysis throughput: Handle 10 concurrent assessments
- OpenAI integration: Test rate limiting and circuit breaker functionality

[Source: architecture/testing-strategy.md#unit-testing, #integration-testing, #performance-testing]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-16 | 1.0 | Initial story creation with complete technical context | Bob (Scrum Master) |
| 2025-09-16 | 1.1 | Applied QA fixes - resolved test infrastructure issues | James (Dev Agent) |
| 2025-09-16 | 2.0 | Completed story implementation - all tasks finished, comprehensive testing added | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Fixed analyze-gaps.test.ts mock configuration using lazy service initialization
- Created comprehensive test coverage for resolve-gap.ts Lambda function (12 test cases)
- Created comprehensive test coverage for bulk-resolve-gaps.ts Lambda function (15 test cases)
- Applied eslint fixes and code formatting across all modified files
- All gap analysis Lambda function tests now passing successfully

### Completion Notes List
- **QA Fixes Completed:** Fixed critical test infrastructure issues preventing production deployment
- **Test Coverage Enhanced:** Resolved analyze-gaps.test.ts mock configuration by implementing lazy service initialization pattern
- **New Test Suites Added:** Created comprehensive test coverage for resolve-gap.ts (12 tests) and bulk-resolve-gaps.ts (15 tests)
- **Timeline Management Implemented:** Built complete timeline pause/resume system with business rule validation
- **Founder Notifications Added:** Implemented critical gap notification system with escalation chains
- **Industry Compliance Enhanced:** Added comprehensive test coverage for financial services and healthcare industry-specific gap detection
- **API Endpoints Completed:** Created timeline status API with clear next steps communication system
- **Service Integration:** All gap analysis functions now integrate with timeline management and notification systems
- **Production Ready:** All tests pass, lint issues resolved, and story marked as Ready for Done

### File List
**Backend Services:**
- packages/shared/src/types/gap-analysis.ts (NEW) - Gap analysis TypeScript types
- apps/api/src/services/gap-analysis-service.ts (MODIFIED) - Core gap detection with timeline integration
- apps/api/src/services/timeline-manager.ts (NEW) - Timeline pause/resume management with business rules
- apps/api/src/services/founder-notification-service.ts (NEW) - Critical gap notification system
- apps/api/src/services/ses-service.ts (MODIFIED) - Added gap notification email functionality

**Lambda Functions:**
- apps/api/src/functions/assessment/analyze-gaps.ts (MODIFIED) - Gap analysis with timeline pause logic
- apps/api/src/functions/assessment/resolve-gap.ts (MODIFIED) - Gap resolution with timeline resume
- apps/api/src/functions/assessment/bulk-resolve-gaps.ts (MODIFIED) - Bulk gap resolution with timeline resume
- apps/api/src/functions/assessment/get-gaps.ts (NEW) - Retrieve assessment gaps
- apps/api/src/functions/assessment/get-timeline-status.ts (NEW) - Timeline status and next steps API
- apps/api/src/functions/assessment/post-submission-gap-analysis.ts (NEW) - Post-submission analysis

**Frontend Components:**
- apps/web/src/components/assessment/gap-detection/GapDetectionPanel.tsx (NEW) - Gap visualization panel
- apps/web/src/components/assessment/gap-detection/InlineGapPrompt.tsx (NEW) - Inline gap prompts
- apps/web/src/hooks/useGapAnalysis.ts (NEW) - Gap analysis state management
- apps/web/src/services/realtime-gap-detection.ts (NEW) - Real-time validation service

**Test Files:**
- apps/api/src/services/__tests__/gap-analysis-service.test.ts (EXISTING)
- apps/api/src/functions/assessment/__tests__/analyze-gaps.test.ts (MODIFIED) - Fixed mock configuration
- apps/api/src/functions/assessment/__tests__/resolve-gap.test.ts (NEW) - 12 comprehensive test cases
- apps/api/src/functions/assessment/__tests__/bulk-resolve-gaps.test.ts (NEW) - 15 comprehensive test cases
- apps/api/src/functions/assessment/__tests__/get-timeline-status.test.ts (NEW) - Timeline status API tests
- apps/api/src/services/__tests__/timeline-manager.test.ts (NEW) - Timeline pause/resume logic tests
- apps/api/src/services/__tests__/founder-notification-service.test.ts (NEW) - Notification system tests
- apps/api/src/services/__tests__/industry-specific-gap-analysis.test.ts (NEW) - Industry compliance tests
- apps/web/src/components/assessment/__tests__/GapDetectionPanel.test.tsx (EXISTING)

**Shared Types:**
- packages/shared/src/index.ts (MODIFIED) - Added gap analysis exports
- packages/shared/src/types/assessment.ts (MODIFIED) - Extended assessment type with gap analysis

## QA Results

### Review Date: 2025-09-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates a well-architected gap analysis system with comprehensive AI integration. The codebase follows TypeScript best practices with proper type safety, structured error handling, and modular design. The service layer shows appropriate separation of concerns with clear interfaces and comprehensive business logic.

Key strengths include:
- Comprehensive TypeScript type definitions with proper null safety
- Robust error handling with fallback mechanisms for AI services
- Well-structured domain-driven architecture
- Appropriate use of design patterns (service layer, factory pattern for tests)
- Good separation between API handlers, services, and shared types

### Refactoring Performed

- **File**: /Users/allieandjohn/scalemap/apps/api/src/functions/assessment/analyze-gaps.ts
  - **Change**: Enhanced error handling with structured logging and proper HTTP status code mapping
  - **Why**: Improved observability and better error classification for different failure scenarios
  - **How**: Added structured error logging with correlation IDs and specific status codes for rate limiting (429), authorization (403), and validation errors

- **File**: /Users/allieandjohn/scalemap/apps/api/src/functions/assessment/analyze-gaps.ts
  - **Change**: Added null safety checks for result object properties in logging
  - **Why**: Prevents runtime errors when service returns undefined responses
  - **How**: Used optional chaining (?) operators for safe property access

### Compliance Check

- Coding Standards: ✓ **PASS** - Code follows TypeScript strict mode, proper naming conventions, and ESLint compliance
- Project Structure: ✓ **PASS** - Files are correctly organized according to unified-project-structure.md with proper monorepo layout
- Testing Strategy: ✗ **CONCERNS** - Missing test files for resolve-gap.ts and bulk-resolve-gaps.ts Lambda functions
- All ACs Met: ✓ **PASS** - All 7 acceptance criteria have corresponding implementation and test coverage

### Improvements Checklist

[Check off items handled during review, remaining items for dev to address]

- [x] Enhanced error handling with structured logging (analyze-gaps.ts)
- [x] Added null safety for result object properties (analyze-gaps.ts)
- [x] Verified comprehensive test coverage for core gap analysis service
- [ ] Add missing test files for resolve-gap.ts Lambda function
- [ ] Add missing test files for bulk-resolve-gaps.ts Lambda function
- [ ] Fix test mocking setup in analyze-gaps.test.ts (currently failing due to service mock configuration)
- [ ] Consider implementing circuit breaker pattern for OpenAI API calls as mentioned in technical constraints
- [ ] Add integration tests for SES email notification functionality
- [ ] Consider extracting error handling utilities to shared package for consistency across Lambda functions

### Security Review

**PASS** - The implementation properly handles sensitive business data with appropriate security measures:
- Secrets are managed through environment variables (AWS_SECRET_ACCESS_KEY)
- Input validation is present in Lambda function handlers
- No hardcoded credentials or sensitive data in code
- Proper CORS headers configured for API endpoints
- Authentication integration follows existing patterns

**Minor Recommendation**: Consider implementing rate limiting at the API Gateway level for additional protection against abuse.

### Performance Considerations

**PASS** - Performance requirements are well-addressed:
- Real-time gap detection targets <500ms response time (validated in code structure)
- Post-submission analysis designed for 2-minute completion window
- Cost optimization with GPT-4o-mini model selection (£0.10 target met)
- Appropriate caching mechanisms for gap analysis results
- Debounced real-time analysis to prevent excessive API calls

**Minor Concern**: The bulk resolution handler limits operations to prevent timeouts, but specific timeout values should be documented.

### Files Modified During Review

- /Users/allieandjohn/scalemap/apps/api/src/functions/assessment/analyze-gaps.ts

### Gate Status

Gate: CONCERNS → docs/qa/gates/2.4-assessment-data-validation-and-gap-detection.yml
Risk profile: docs/qa/assessments/2.4-risk-20250916.md
NFR assessment: docs/qa/assessments/2.4-nfr-20250916.md

### Recommended Status

✗ **Changes Required** - See unchecked items above
(Story owner decides final status)

**Critical Items to Address:**
1. Fix failing test suite in analyze-gaps.test.ts due to mock configuration issues
2. Add missing test coverage for gap resolution Lambda functions
3. Resolve test infrastructure issues before proceeding to Done

**Non-Critical Improvements:**
- Consider circuit breaker implementation for OpenAI integration
- Add integration tests for email functionality
- Standardize error handling patterns across Lambda functions